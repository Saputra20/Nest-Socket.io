<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }

      .chat-container {
        display: flex;
        max-width: 1200px;
        margin: 0 auto;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .rooms-list {
        flex: 1;
        padding: 15px;
        background-color: #f1f1f1;
        border-right: 1px solid #ccc;
      }

      .rooms-list h2 {
        margin-bottom: 10px;
      }

      .rooms-list ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .rooms-list li {
        padding: 10px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .rooms-list li.active {
        background-color: #ddd;
      }

      .chat-room {
        flex: 2;
        padding: 15px;
      }

      .chat-header h2 {
        margin: 0;
      }

      .chat-messages {
        margin-top: 20px;
      }

      .message {
        margin-bottom: 15px;
        display: flex;
        justify-content: flex-start;
      }

      .incoming .message-content {
        background-color: #f1f0f0;
        padding: 10px;
        border-radius: 5px;
      }

      .outgoing {
        justify-content: flex-end;
      }

      .outgoing .message-content {
        background-color: #007bff;
        color: #fff;
        padding: 10px;
        border-radius: 5px;
      }

      .chat-input {
        display: flex;
        margin-top: 20px;
      }

      .chat-input textarea {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        resize: none;
      }

      .chat-input button {
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="rooms-list">
        <h2>Chat Rooms</h2>
        <ul id="rooms"></ul>
      </div>

      <div class="chat-room">
        <div class="chat-header" id="room-name">
          <h2>Room Name</h2>
        </div>
        <div class="chat-messages" id="chat-messages" style="padding-top: 50px">
        </div>

        <form id="form" action="" class="chat-input">
          <textarea
            placeholder="Type your message"
            id="input"
            autocomplete="off"
          ></textarea>
          <button>Send</button>
        </form>
      </div>
    </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    async function getRooms() {
      try {
        var ul = document.getElementById('rooms');
        const response = await fetch('/room', {
          method: 'GET',
        });

        const rooms = await response.json();

        for (const room of rooms) {
          var li = document.createElement('li');
          var button = document.createElement('a');
          button.innerHTML = room.name;
          button.id = room.channel;
          button.setAttribute('onClick', `detailRoom("${room.channel}")`);

          li.appendChild(button);
          ul.appendChild(li);
        }
      } catch (error) {
        console.error('An error occurred:', error);
      }
    }

    async function detailRoom(channel) {
      try {
        var ul = document.getElementById('rooms');
        const response = await fetch(`/room/${channel}`, {
          method: 'GET',
        });

        const room = await response.json();
        document.getElementById(
          'room-name',
        ).innerHTML = `<h2>${room.name}</h2>`;
        roomId = room._id;
      } catch (error) {
        console.error('An error occurred:', error);
      }
    }

    getRooms();

    // socket io
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    let roomId = null;

    var socket = io.connect('', { query: `id=${id}` });

    var roomMessages = document.getElementById('chat-messages');
    var form = document.getElementById('form');

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (input.value) {
        socket.emit('message', {
          userId: id,
          message: input.value,
          roomId: roomId,
        });
        input.value = '';
      }
    });

    socket.on(id, function (msg) {
      console.log(msg);
      const incomingMessageDiv = document.createElement('div');
      incomingMessageDiv.classList.add('message', 'incoming');

      const messageContentDiv = document.createElement('div');
      messageContentDiv.classList.add('message-content');
      messageContentDiv.textContent = msg;

      incomingMessageDiv.appendChild(messageContentDiv);
      roomMessages.appendChild(incomingMessageDiv);
      window.scrollTo(0, document.body.scrollHeight);
    });
  </script>
</html>
